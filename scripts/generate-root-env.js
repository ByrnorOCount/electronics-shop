import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";

// Helper to get __dirname in ES modules
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Define project root
const projectRoot = path.resolve(__dirname, "..");

/**
 * Parses a .env file content and returns a key-value object.
 * @param {string} filePath
 * @returns {Record<string, string>}
 */
function parseEnvFile(filePath) {
  if (!fs.existsSync(filePath)) {
    console.warn(`[WARN] Environment file not found: ${filePath}`);
    return {};
  }
  const content = fs.readFileSync(filePath, "utf-8");
  const envConfig = {};
  content.split("\n").forEach((line) => {
    const trimmedLine = line.trim();
    if (trimmedLine && !trimmedLine.startsWith("#")) {
      const [key, ...valueParts] = trimmedLine.split("=");
      const value = valueParts.join("=").trim();
      if (key) {
        envConfig[key.trim()] = value;
      }
    }
  });
  return envConfig;
}

const backendEnv = parseEnvFile(path.join(projectRoot, "backend", ".env"));
const frontendEnv = parseEnvFile(path.join(projectRoot, "frontend", ".env"));

const rootEnvContent = `
# This file is auto-generated by scripts/generate-root-env.js for Docker Compose. Run npm run docker:prepare to regenerate.
# DO NOT EDIT THIS FILE MANUALLY.

DB_USER=${backendEnv.DB_USER || ""}
DB_PASSWORD=${backendEnv.DB_PASSWORD || ""}
DB_DATABASE=${backendEnv.DB_DATABASE || ""}
VITE_API_BASE_URL=${frontendEnv.VITE_API_BASE_URL || ""}
VITE_STRIPE_PUBLIC_KEY=${frontendEnv.VITE_STRIPE_PUBLIC_KEY || ""}
`;

fs.writeFileSync(path.join(projectRoot, ".env"), rootEnvContent.trim());

console.log("[SUCCESS] Root .env file generated for Docker Compose.");
